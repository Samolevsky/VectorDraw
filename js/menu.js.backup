// function related to the main menu

pg.menu = function() {
	
	var setup = function() {
		setupNavigationLogic();
		setupFileSection();
	};


	var setupNavigationLogic = function() {
		
		// click on $topMenuButton sets active state on button and shows/hides 
		// submenu. also shows/hides inputblocker in the background (transparent)
		jQuery('#appNav .topMenu>li').off('click').on('click', function(e) {
			e.stopPropagation();
			var $button = jQuery(this);
			jQuery('#appNav .topMenu>li').not($button).removeClass('active');
			jQuery('#appNav .subMenu').hide();
			
			if(!$button.hasClass('empty')) {			
				$button.parent().addClass('active');

				if($button.hasClass('active')) {
					closeMainMenu();
				 
				} else {
					$button.addClass('active').children('ul').show();
					$button.find('.subSubMenu').removeClass('active');
					jQuery('#menuInputBlocker').show();
				}
			}
		});
		
		
		jQuery('#appNav .subMenu .hasSubSubMenu').off('click').on('click', function(e) {
			e.stopPropagation();
			var $subSubMenu = jQuery(this).children('ul');
			$subSubMenu.toggleClass('active');
		});
		
		
		jQuery('.subSubMenu>li').on('click', function(e) {
			e.stopPropagation();
			closeMainMenu();
		});
		
		
		jQuery('#menuInputBlocker').off('click').on('click', function(e) {
			hideMenus();
		});
	 
	};
	
	
	var closeMainMenu = function() {
		jQuery('.topMenuButton').removeClass('active');
		jQuery('.subMenu').hide();
		jQuery('.subSubMenu').removeClass('active');
		jQuery('#menuInputBlocker').hide();
	};
	
	
	var setupFileSection = function() {
		
		jQuery('.clearDocument_button').click(function() {
			if (confirm('Clear the document permanently?')) {
				pg.document.clear();
			}
		});
	 
		jQuery('.resetSettings_button').click(function() {
			if (confirm('Clear all document and tool settings?')) {
				pg.settings.clearSettings();
			}
		});
		
		// handle change on hidden file input in menu item
		jQuery('#fileUploadSVG').on('change', function(event) {
			pg.helper.processFileInput('text', event.target, function(data) {
				pg.import.importAndAddSVG(data);
			});
		});
		
		// handle change on hidden file input in menu item
		jQuery('#fileUploadJSON').on('change', function(event) {
			pg.helper.processFileInput('text', event.target, function(data) {
				pg.document.loadJSONDocument(data);
			});
		});
		
		jQuery('.undo_button').click(function() {
			pg.undo.undo();
		});
		
		jQuery('.redo_button').click(function() {
			pg.undo.redo();
		});
		
		
		// handle change on hidden file input in menu item
		jQuery('#fileUploadImage').on('change', function(event) {
			pg.helper.processFileInput('dataURL', event.target, function(dataURL) {
				pg.import.importAndAddImage(dataURL);
			});
		});
				
		jQuery('.importImageFromURL_button').click(function() {
			var url = prompt("Paste URL to Image (jpg, png, gif)", "http://");
			if(url) {
				pg.import.importAndAddExternalImage(url);
			}
		});
		
		jQuery('.importSVGFromURL_button').click(function () {
			var url = prompt("Paste URL to SVG", "http://");
			if (url) {
				pg.import.importAndAddSVG(url);
			}
		});
		
		jQuery('.exportJSON_button').click(function() {
			pg.document.saveJSONDocument();
		});
		
		// export click handler in menu
		jQuery('.exportSVG_button').click(function() {
			pg.export.exportAndPromptSVG();
		});

		jQuery('.exportImage_button').click(function() {
			pg.export.exportAndPromptImage();
		});
		
		jQuery('.zoomIn_button').click(function() {
			pg.view.zoomBy(1.25);
		});
		
		jQuery('.zoomOut_button').click(function() {
			pg.view.zoomBy(1/1.25);
		});
		
		jQuery('.resetZoom_button').click(function() {
			pg.view.resetZoom();
		});
		
		jQuery('.resetPan_button').click(function() {
			pg.view.resetPan();
		});
		
		// Window menu - panel buttons
		jQuery('.windowPanelButton').click(function() {
			var panelType = jQuery(this).attr('data-panel');
			// Create floating panel centered on screen
			var centerX = window.innerWidth / 2;
			var centerY = window.innerHeight / 2;
			pg.floatingPanels.createCenteredPanel(panelType, centerX, centerY);
		});
		
		jQuery('.aboutButton').click(function() {
			showAboutModal();
		});

	};

	
	var setupToolEntries = function(entries) {
		var $toolMenu = jQuery('#toolSubMenu');		
		$toolMenu.empty().parent().removeClass('empty');
		var $subMenuAttachParent = null;
		jQuery.each(entries, function(index, entry) {
			if(entry.type === 'title') {
				$toolMenu.append(jQuery('<li class="space"></li>'));
				var $subSubMenuButton = jQuery('<li class="hasSubSubMenu">'+entry.text+'</li>');
				$subMenuAttachParent = jQuery('<ul class="subSubMenu">');
				$subSubMenuButton.append($subMenuAttachParent);
				$toolMenu.append($subSubMenuButton);
				
			} else if(entry.type === 'button') {
				var classString = entry.class ? ' '+entry.class : '' ;
				var $toolButton = jQuery('<li class="button'+classString+'" data-click="'+entry.click+'">'+entry.label+'</li>');
				
				$toolButton.click(function() {
					var func = jQuery(this).attr('data-click');
					pg.helper.executeFunctionByName(func, window);
					setTimeout(function() {
						hideMenus();
					}, 100);
				});
				if($subMenuAttachParent === undefined) {
					$toolMenu.append($toolButton);
				} else {
					$subMenuAttachParent.append($toolButton);
				}
			}
			
		});
		setupNavigationLogic();
	};
	
	
	var clearToolEntries = function() {
		jQuery('#toolSubMenu').empty().parent().addClass('empty');
	};
	

	var showContextMenu = function(event) {
	
		// check for selected items, so the right context menu can be opened
		if(pg.selection.getSelectedItems().length > 0) {
			if(jQuery('#appNavContextMenu').length > 0) {
				return;
			}
			// create, append and position context menu for object context
			jQuery('body').append("<nav class='appNav' id='appNavContextMenu'></nav>");
			
			var $menu = jQuery('#toolSubMenu')
				.clone(true)
				.appendTo('#appNavContextMenu')
				.show();
			
			var menuPosY = event.pageY;
			var diff = (jQuery(document).height() - event.pageY) - $menu.outerHeight();
			if(diff < 0) {
				menuPosY += diff - 10; 
			}
			$menu.css({ 'position': 'absolute', 'top': menuPosY, 'left': event.pageX });
			
			jQuery('#menuInputBlocker').show();
			
		} else {
			//todo: create context menu for document context
		}
	
	};
	
	var hideMenus = function() {
		jQuery('#appNav .topMenu>li').removeClass('active');
		jQuery('#appNav .topMenu').removeClass('active');
		jQuery('#appNav .subMenu').hide();
		jQuery('#menuInputBlocker').hide();
		hideContextMenu();
	};
	
	
	var hideContextMenu = function() {
		
		jQuery('body').off('click.contextMenu');
		jQuery('body>#appNavContextMenu').remove();
		jQuery('#menuInputBlocker').hide();
		
	};
		
	
	var showAboutModal = function () {
		var eulaContent = '<div class="eula-content">' +
			'<h3>End User License Agreement</h3>' +
			'<p><strong>Effective Date:</strong> November 22, 2025</p>' +
			'<p>This End User License Agreement ("Agreement") is entered into between Arseny Samolevsky ("Licensor") and you ("End User" or "You").</p>' +
			'<h4>1. Grant of License</h4>' +
			'<p>Subject to the terms of this Agreement, Licensor grants You a non-exclusive, non-transferable, revocable license to use VectorDraw ("Software") for personal or commercial purposes.</p>' +
			'<h4>2. Restrictions on Use</h4>' +
			'<p>You may not:</p>' +
			'<ul>' +
			'<li>Modify, reverse engineer, decompile, or disassemble the Software except as permitted by applicable law</li>' +
			'<li>Remove or alter any proprietary notices or labels on the Software</li>' +
			'<li>Use the Software for any unlawful purpose</li>' +
			'<li>Redistribute or resell the Software without explicit written permission</li>' +
			'</ul>' +
			'<h4>3. Intellectual Property Rights</h4>' +
			'<p>The Software and all worldwide intellectual property rights therein are the exclusive property of Arseny Samolevsky. All rights not expressly granted to You are reserved by Licensor.</p>' +
			'<h4>4. Disclaimer of Warranties</h4>' +
			'<p>THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT. LICENSOR DOES NOT WARRANT THAT THE SOFTWARE WILL BE ERROR-FREE OR UNINTERRUPTED.</p>' +
			'<h4>5. Limitation of Liability</h4>' +
			'<p>IN NO EVENT SHALL LICENSOR BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, OR ANY LOSS OF PROFITS OR REVENUES, WHETHER INCURRED DIRECTLY OR INDIRECTLY, OR ANY LOSS OF DATA, USE, GOODWILL, OR OTHER INTANGIBLE LOSSES RESULTING FROM YOUR USE OF THE SOFTWARE.</p>' +
			'<h4>6. Termination</h4>' +
			'<p>This Agreement is effective until terminated. Your rights under this Agreement will terminate automatically without notice if You fail to comply with any term of this Agreement. Upon termination, You must cease all use of the Software.</p>' +
			'<h4>7. Governing Law</h4>' +
			'<p>This Agreement shall be governed by and construed in accordance with the laws of the jurisdiction in which Licensor resides, without regard to its conflict of law provisions.</p>' +
			'<h4>8. Contact Information</h4>' +
			'<p>For questions regarding this Agreement, please contact:<br>Arseny Samolevsky<br>Website: <a href="https://samolevsky.com/" target="_blank" rel="noopener noreferrer">samolevsky.com</a></p>' +
			'<h4>9. Entire Agreement</h4>' +
			'<p>This Agreement constitutes the entire agreement between You and Licensor regarding the Software and supersedes all prior agreements and understandings.</p>' +
			'</div>';
		
		var html = '<h2 class="appTitle">VectorDraw</h2>' +
			'<span class="versionNumber">' + pg.settings.getVersionNumber() + '</span>' +
			'<p class="app-description">A powerful browser-based vector graphics editor built on Paper.js. Create, edit, and export professional vector artwork with an intuitive interface and comprehensive toolset.</p>' +
			'<button class="discover-tools-btn" id="discoverToolsBtn">' +
			'<span>Discover More Design Tools</span>' +
			'<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
			'<path d="M6 3L11 8L6 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
			'</svg>' +
			'</button>' +
			'<div class="eula-section">' +
			'<div class="eula-header" id="eulaHeader">' +
			'<span>End User License Agreement</span>' +
			'<svg class="chevron-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">' +
			'<path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
			'</svg>' +
			'</div>' +
			'<div class="eula-body" id="eulaBody">' +
			eulaContent +
			'</div>' +
			'</div>' +
			'<p class="about-credits">Created by <a href="https://www.samolevsky.com/" target="_blank" rel="noopener noreferrer" id="samolevskyCreditLink">Samolevsky.com</a></p>';
		
		new pg.modal.floater('appInfoWindow', 'About', html, 600, 100);
		
		// Add event listeners after modal is created
		setTimeout(function() {
			jQuery('#discoverToolsBtn').off('click').on('click', function(e) {
				e.preventDefault();
				window.open('https://samolevsky.com/', '_blank', 'noopener,noreferrer');
			});
			
			jQuery('#eulaHeader').off('click').on('click', function() {
				var $body = jQuery('#eulaBody');
				var $header = jQuery('#eulaHeader');
				
				if ($body.hasClass('expanded')) {
					$body.removeClass('expanded');
					$header.removeClass('expanded');
				} else {
					$body.addClass('expanded');
					$header.addClass('expanded');
				}
			});
		}, 50);
	};
	
	
	return {
		setup:setup,
		setupToolEntries: setupToolEntries,
		clearToolEntries: clearToolEntries,
		showContextMenu:showContextMenu,
		hideContextMenu:hideContextMenu,
		showAboutModal: showAboutModal
	};
	
}();

